{% extends "main/katalogbase.html" %}
{% load static %}
{% block title %}Furnibuild - Catalog{% endblock title %}
{% block content %}
<section class="hero">
  <div class="container hero-grid">
    <div>
      <h1>Ready-made solutions for your business</h1>
      <p>We offer a wide selection of commercial furniture. Choose a ready-made solution or request a custom project designed for your niche.</p>
      <a class="btn" href="{% url "main:catalog" %}">Browse catalog</a>
    </div>
    <div class="hero-imgs">
      <div class="img1">
      </div>
      <img class="img2" src="{% static "/img/katalogbase/image_2066.png" %}" alt="">
      <img class="img3" src="{% static "/img/katalogbase/image_2065.png" %}" alt="">
    </div>
  </div>
</section>
<section class="toolbar">
    <div class="container">
      <div class="row">
        <div class="search">
          <input id="search-desktop" type="search" placeholder="Search" value="{{ q|default_if_none:'' }}">
          <svg class="search-ic" id="search-ic-svg" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.6"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        </div>
        <div class="sort">
          <label class="muted">Sort by:</label>
          <select class="select" id="sort-select">
            <option value="default" {% if sort == 'default' %}selected{% endif %}>Default order</option>
            <option value="price-asc" {% if sort == 'price-asc' %}selected{% endif %}>Price: Low to High</option>
            <option value="price-desc" {% if sort == 'price-desc' %}selected{% endif %}>Price: High to Low</option>
            <option value="name-asc" {% if sort == 'name-asc' %}selected{% endif %}>Name: A–Z</option>
            <option value="name-desc" {% if sort == 'name-desc' %}selected{% endif %}>Name: Z–A</option>
          </select>
        </div>
      </div>
    </div>
  </section>
  
  <div class="m-topbar" id="mTopbar">
    <div class="container">
      <div class="bar">
        <button class="filter-open" id="openFilters" aria-expanded="false">
          <svg class="ic" viewBox="0 0 24 24" fill="none"><path d="M3 7h18M6 12h12M10 17h4" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
          Filters
        </button>
        <button class="m-s-icon" id="openSearch" aria-label="Search">
          <svg class="ic" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.8"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
        </button>
      </div>
  
      <div class="m-filters-panel" id="mFiltersPanel" style="display:none">
        <div class="m-search-row">
          <input id="search-mobile" type="search" placeholder="Search" value="{{ q|default_if_none:'' }}">
          <button class="m-search-go" id="searchGoMobile" aria-label="Search">
            <svg class="ic" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.8"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
          </button>
        </div>
  
        <div class="accord" data-acc="sort">
          <div class="head">
            <div class="muted" style="font-size:14px">Sort</div>
            <svg class="ic" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </div>
          <div class="body">
            <div class="list" style="display:grid;gap:8px">
              <label class="check"><input type="radio" name="m-sort" value="default" {% if sort == 'default' %}checked{% endif %}> Default order</label>
              <label class="check"><input type="radio" name="m-sort" value="price-asc" {% if sort == 'price-asc' %}checked{% endif %}> Price: Low to High</label>
              <label class="check"><input type="radio" name="m-sort" value="price-desc" {% if sort == 'price-desc' %}checked{% endif %}> Price: High to Low</label>
              <label class="check"><input type="radio" name="m-sort" value="name-asc" {% if sort == 'name-asc' %}checked{% endif %}> Name: A–Z</label>
              <label class="check"><input type="radio" name="m-sort" value="name-desc" {% if sort == 'name-desc' %}checked{% endif %}> Name: Z–A</label>
            </div>
          </div>
        </div>
  
        <div class="accord" data-acc="price">
          <div class="head">
            <div class="muted" style="font-size:14px">Price</div>
            <svg class="ic" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </div>
          <div class="body">
            <div class="range-inputs">
              <input type="text" class="price-min" id="priceMinMobile" inputmode="numeric" aria-label="Min price" value="{{ pmin }}">
              <input type="text" class="price-max" id="priceMaxMobile" inputmode="numeric" aria-label="Max price" value="{{ pmax }}">
              <button class="price-ok" id="priceOk">OK</button>
            </div>
          </div>
        </div>
  
        <div class="accord" data-acc="section">
          <div class="head">
            <div class="muted" style="font-size:14px">Sections</div>
            <svg class="ic" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </div>
          <div class="body">
            <div class="muted">No sections yet</div>
          </div>
        </div>
  
        <div class="accord" data-acc="colors">
          <div class="head">
            <div class="muted" style="font-size:14px">Colors</div>
            <svg class="ic" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </div>
          <div class="body">
            <div class="list" id="colorListMobile" style="display:grid;gap:8px">
              {% for c in colors_all %}
                <label class="check" style="display:flex;gap:8px;align-items:center">
                  <input type="checkbox" class="color-check" value="{{ c }}" {% if c in selected_colors %}checked{% endif %}>
                  <span>{{ c }}</span>
                </label>
              {% empty %}
                <div class="muted">No colors defined</div>
              {% endfor %}
            </div>
          </div>
        </div>
  
        <div style="padding-top:10px">
          <div class="muted" style="font-size:14px;margin-bottom:6px">Applied filters</div>
          <div class="chips">
            {% if pmin > price_min_all %}
              <span class="chip">≥ ${{ pmin|floatformat:0 }} <a href="?{{ qs_remove_pmin }}" aria-label="Remove">×</a></span>
            {% endif %}
            {% if pmax < price_max_all %}
              <span class="chip">≤ ${{ pmax|floatformat:0 }} <a href="?{{ qs_remove_pmax }}" aria-label="Remove">×</a></span>
            {% endif %}
            {% for c, qs_rm in selected_colors_with_qs %}
              <span class="chip">{{ c }} <a href="?{{ qs_rm }}" aria-label="Remove color">×</a></span>
            {% endfor %}
          </div>
          <a class="clear-all" href="?{{ qs_clear_all }}">Clear all</a>
        </div>
      </div>
    </div>
  </div>
  
  <section id="catalog" class="catalog">
    <div class="container layout">
      <aside class="filters" id="sidebar" aria-label="Filters">
        <h3>Filters</h3>
  
        <div class="group">
          <div class="muted">Price</div>
          <div class="range-wrap">
            <div class="range-inputs">
              <input type="text" class="price-min" id="priceMinDesktop" inputmode="numeric" value="{{ pmin }}">
              <input type="text" class="price-max" id="priceMaxDesktop" inputmode="numeric" value="{{ pmax }}">
            </div>
            <div class="range-line">
              <input type="range" min="{{ price_min_all }}" max="{{ price_max_all }}" value="{{ pmin }}" class="slider slider-min" id="sliderMinDesktop" aria-label="Min price">
              <input type="range" min="{{ price_min_all }}" max="{{ price_max_all }}" value="{{ pmax }}" class="slider slider-max" id="sliderMaxDesktop" aria-label="Max price">
            </div>
          </div>
        </div>
  
        <div class="group">
          <div class="muted">Colors</div>
          <div class="list" id="colorListDesktop" style="display:grid;gap:8px;padding:8px 0 12px">
            {% for c in colors_all %}
              <label class="check" style="display:flex;gap:8px;align-items:center">
                <input type="checkbox" class="color-check" value="{{ c }}" {% if c in selected_colors %}checked{% endif %}>
                <span>{{ c }}</span>
              </label>
            {% empty %}
              <div class="muted">No colors defined</div>
            {% endfor %}
          </div>
        </div>
  
        <div class="group">
          <div class="muted">Sections</div>
          <div class="list" style="display:grid;gap:8px;padding:8px 0 12px">
            <div class="muted">No sections yet</div>
          </div>
        </div>
  
        <div class="group">
          <div class="muted">You selected</div>
          <div class="chips" id="chipsDesktop">
            {% if pmin > price_min_all %}
              <span class="chip">≥ ${{ pmin|floatformat:0 }} <a href="?{{ qs_remove_pmin }}" aria-label="Remove">×</a></span>
            {% endif %}
            {% if pmax < price_max_all %}
              <span class="chip">≤ ${{ pmax|floatformat:0 }} <a href="?{{ qs_remove_pmax }}" aria-label="Remove">×</a></span>
            {% endif %}
            {% for c, qs_rm in selected_colors_with_qs %}
              <span class="chip">{{ c }} <a href="?{{ qs_rm }}" aria-label="Remove color">×</a></span>
            {% endfor %}
          </div>
          <a class="clear-all" href="?{{ qs_clear_all }}" id="clearDesktop">Clear all</a>
        </div>
      </aside>
  
      <main>
        <div class="chips" id="chipsInline" style="margin:0 0 18px">
          {% if pmin > price_min_all %}
            <span class="chip">≥ ${{ pmin|floatformat:0 }} <a href="?{{ qs_remove_pmin }}" aria-label="Remove">×</a></span>
          {% endif %}
          {% if pmax < price_max_all %}
            <span class="chip">≤ ${{ pmax|floatformat:0 }} <a href="?{{ qs_remove_pmax }}" aria-label="Remove">×</a></span>
          {% endif %}
          {% for c, qs_rm in selected_colors_with_qs %}
            <span class="chip">{{ c }} <a href="?{{ qs_rm }}" aria-label="Remove color">×</a></span>
          {% endfor %}
        </div>
  
        <div class="grid" id="grid">
          {% include 'main/_product_cards.html' %}
        </div>
  
        {% if not products %}
          <div id="empty" class="empty">No items found</div>
        {% endif %}
  
        {% if has_more %}
          <div style="display:flex;justify-content:center;margin-top:24px">
            <button id="loadMoreBtn" class="btn secondary" data-next-page="{{ next_page }}">Load more</button>
          </div>
        {% endif %}
      </main>
    </div>
  </section>


{% endblock content %}
{% block script %}
    (function(){
      // Format prices
      $$('.price .p').forEach(span=>{
        const raw = span.dataset.price || span.textContent;
        const n = parseInt(String(raw).replace(/[^\d]/g,''),10) || 0;
        span.textContent = n.toLocaleString('en-US');
      });
    
      // Query helpers
      function buildUrl(updates){
        const url = new URL(window.location.href);
        const params = url.searchParams;
        Object.entries(updates).forEach(([k,v])=>{
          if(Array.isArray(v)){
            params.delete(k);
            v.forEach(val => params.append(k, val));
          }else{
            if(v === null || v === undefined || v === '') params.delete(k);
            else params.set(k, v);
          }
        });
        params.delete('page'); // reset pagination
        url.search = params.toString();
        return url.toString();
      }
      function applyAndGo(updates){ window.location.href = buildUrl(updates); }
    
      // Search
      const sDesktop = $('#search-desktop');
      const sMobile  = $('#search-mobile');
    
      [sDesktop,sMobile].forEach(inp=>{
        if(!inp) return;
        inp.addEventListener('keydown', e=>{
          if(e.key==='Enter'){ e.preventDefault(); applyAndGo({ q: e.target.value.trim() || null }); }
        });
      });
      $('#desktop-search-toggle')?.addEventListener('click', ()=> sDesktop?.focus());
      // loupes
      $('#search-ic-svg')?.addEventListener('click', ()=> applyAndGo({ q: sDesktop?.value?.trim() || null }));
      $('#searchGoMobile')?.addEventListener('click', ()=> applyAndGo({ q: sMobile?.value?.trim() || null }));
    
      // Sort
      $('#sort-select')?.addEventListener('change', e=> applyAndGo({ sort: e.target.value || null }));
      $$('input[name="m-sort"]').forEach(r=>{
        r.addEventListener('change', e=> applyAndGo({ sort: e.target.value || null }));
      });
    
      // Price
      const priceMinAll = {{ price_min_all|default:0 }};
      const priceMaxAll = {{ price_max_all|default:0 }};
      function readNum(v){ return parseInt(String(v||'').replace(/[^\d]/g,''),10) || 0; }
      function clampPair(a,b){
        a = Math.max(priceMinAll, Math.min(a, priceMaxAll));
        b = Math.max(priceMinAll, Math.min(b, priceMaxAll));
        if(a>b){ const t=a; a=b; b=t; }
        return [a,b];
      }
      function formatUS(n){ return (n||0).toLocaleString('en-US'); }
    
      const minI = $('#priceMinDesktop');
      const maxI = $('#priceMaxDesktop');
      const minS = $('#sliderMinDesktop');
      const maxS = $('#sliderMaxDesktop');
    
      function syncPriceInputsDisplay(a,b,skip){
        if(minI && skip !== minI) minI.value = formatUS(a);
        if(maxI && skip !== maxI) maxI.value = formatUS(b);
        if(minS) minS.value = a;
        if(maxS) maxS.value = b;
      }
      syncPriceInputsDisplay({{ pmin }}, {{ pmax }});
      function applyPrice(a,b){ applyAndGo({ pmin:a, pmax:b }); }
    
      minI?.addEventListener('input', e=>{
        const [a,b] = clampPair(readNum(e.target.value), readNum(maxI?.value));
        syncPriceInputsDisplay(a,b, e.target);
      });
      maxI?.addEventListener('input', e=>{
        const [a,b] = clampPair(readNum(minI?.value), readNum(e.target.value));
        syncPriceInputsDisplay(a,b, e.target);
      });
      const commitDesktopPrice = ()=>{
        const [a,b] = clampPair(readNum(minI?.value), readNum(maxI?.value));
        applyPrice(a,b);
      };
      minI?.addEventListener('blur', commitDesktopPrice);
      maxI?.addEventListener('blur', commitDesktopPrice);
      [minI,maxI].forEach(i=> i?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); commitDesktopPrice(); }}));
    
      minS?.addEventListener('input', e=>{
        const [a,b] = clampPair(readNum(e.target.value), readNum(maxS?.value));
        syncPriceInputsDisplay(a,b);
      });
      maxS?.addEventListener('input', e=>{
        const [a,b] = clampPair(readNum(minS?.value), readNum(e.target.value));
        syncPriceInputsDisplay(a,b);
      });
      minS?.addEventListener('change', ()=> commitDesktopPrice());
      maxS?.addEventListener('change', ()=> commitDesktopPrice());
    
      // Mobile price OK
      const minM = $('#priceMinMobile');
      const maxM = $('#priceMaxMobile');
      $('#priceOk')?.addEventListener('click', ()=>{
        const [a,b] = clampPair(readNum(minM?.value), readNum(maxM?.value));
        applyPrice(a,b);
      });
    
      // Colors (desktop + mobile)
      function applyColorsFromDocument(){
        const vals = Array.from(new Set($$('input.color-check:checked').map(i=> i.value)));
        applyAndGo({ color: vals });
      }
      $$('.color-check').forEach(chk=> chk.addEventListener('change', applyColorsFromDocument));
    
      // Mobile unified panel
      const mFiltersPanel = $('#mFiltersPanel');
      const openFiltersBtn = $('#openFilters');
      const openSearchBtn = $('#openSearch');
    
      function toggleMobilePanel(force){
        const open = typeof force === 'boolean' ? force : (mFiltersPanel.style.display !== 'block');
        mFiltersPanel.style.display = open ? 'block' : 'none';
        openFiltersBtn?.classList.toggle('is-active', open);
        openSearchBtn?.classList.toggle('is-active', open);
        openFiltersBtn?.setAttribute('aria-expanded', String(open));
        if(open){ setTimeout(()=> $('#search-mobile')?.focus(), 60); }
      }
      openFiltersBtn?.addEventListener('click', ()=> toggleMobilePanel());
      openSearchBtn?.addEventListener('click', ()=> toggleMobilePanel());
    
      // Accordions (mobile)
      $$('.m-filters-panel .accord .head').forEach(head=>{
        head.addEventListener('click', ()=>{
          head.parentElement.classList.toggle('open');
        });
      });
    
      // Load more via AJAX
      const loadMoreBtn = $('#loadMoreBtn');
      const grid = $('#grid');
      function getCurrentParams(){ return new URLSearchParams(window.location.search); }
      loadMoreBtn?.addEventListener('click', async ()=>{
        const next = loadMoreBtn.dataset.nextPage;
        if(!next) return;
        const params = getCurrentParams();
        params.set('page', next);
        const url = new URL('{{ request.build_absolute_uri }}', window.location.origin);
        url.pathname = '{{ request.path|cut:"catalog/" }}catalog/load-more/'.replace('//','/');
        url.search = params.toString();
    
        loadMoreBtn.disabled = true;
        try{
          const res = await fetch(url.toString(), { headers: { 'X-Requested-With':'XMLHttpRequest' }});
          const data = await res.json();
          grid.insertAdjacentHTML('beforeend', data.html);
          if(data.has_more){
            loadMoreBtn.dataset.nextPage = data.next_page;
            loadMoreBtn.disabled = false;
          }else{
            loadMoreBtn.remove();
          }
          $$('.price .p', grid).forEach(span=>{
            if(span.dataset._fmt) return;
            const n = parseInt(String(span.dataset.price||span.textContent).replace(/[^\d]/g,''),10)||0;
            span.textContent = n.toLocaleString('en-US');
            span.dataset._fmt = '1';
          });
        }catch(e){
          console.error(e);
          loadMoreBtn.disabled = false;
        }
      });
    })();
{% endblock script %}
